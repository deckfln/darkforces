<behaviortree>
	<!-- ******************************************************************** -->
	<messages>
		<message id='GameEngine:HEAR_SOUND'>GameEngine:onHearSound</message>
		<message id='GameEngine:VIEW'>GameEngine:onViewPlayer</message>
		<message id='GameEngine:NOT_VIEW'>GameEngine:onNotViewPlayer</message>
		<message id='GameEngine:BULLET_HIT'>GameEngine:onBulletHit</message>
		<message id='DarkForces:DYING'>DarkForces:onDying</message>
	</messages>
	<!-- ******************************************************************** -->
	<tasks>
		<task class='moveAndOpenDoor' description=''>
			<node type='Loop' name='moveAndOpenDoor'>
				<condition>until_one_success</condition>
				<tree>
					<node type='SatNav' name='go directy to final position'>
						<variable type='vec3'>static_position</variable>
					</node>
					<node type='Decorator' name='fail if didnt collid with an elevator'>
						<condition>invert</condition>
						<tree>
							<node type='DarkForces:SetVar' name='check if the entity collided with an elevator'>
								<variable type='ptr'>wait_elevator</variable>
								<value type='ptr'>=findElevator</value>
							</node>
						</tree>
					</node>
					<node type='Decorator' name='invert'>
						<condition>invert</condition>
						<tree>
							<node type='Sequence' name='wait for door or open door'>
								<condition>exit_first_success</condition>
								<tree>
									<node type='DarkForces:WaitDoor' name='if door is opening, wait for end of opening'>
										<variable type='ptr'>wait_elevator</variable>
									</node>
									<node type='Sequence' name='open a door to go to wait position'>
										<tree>
											<node type='DarkForces:SetVar' name='number of triggers of an elevator'>
												<variable type='int32'>max_triggers</variable>
												<value type='int32'>=elevator.triggers.count</value>
											</node>
											<node type='GameEngine:For' name='try to reach each trigger of the door'>
												<variable type='int32'>trigger</variable>
												<start type='int32'>0</start>
												<end type='int32'>=max_triggers</end>
												<condition>until_all_success</condition>
												<default_return>failure</default_return>
												<tree>
													<node type='DarkForces:SetVar' name='position of current trigger'>
														<variable type='vec3'>trigger_position</variable>
														<value type='vec3'>=elevator.triggers[trigger].position</value>
													</node>
													<node type='DarkForces:SetVar' name='name of current trigger'>
														<variable type='string'>trigger_name</variable>
														<value type='string'>=elevator.triggers[trigger].name</value>
													</node>
													<node type='SatNav' name='go to trigger'>
														<variable type='vec3'>trigger_position</variable>
													</node>
												</tree>
											</node>
											<node type='DarkForces:Activate' name='push the trigger'>
												<variable>trigger_name</variable>
											</node>
											<node type='DarkForces:WaitDoor' name='wait for door to open'>
												<variable type='ptr'>wait_elevator</variable>
											</node>
										</tree>
									</node>
								</tree>
							</node>
						</tree>
					</node>
				</tree>
			</node>

		</task>
	</tasks>
	<!-- ******************************************************************** -->
	<blackboard>
		<variable>
			<variable type='bool'>player_visible</variable>
			<value type='bool'>false</value>
		</variable>
		<variable>
			<variable type='bool'>hit_bullet</variable>
			<value type='bool'>false</value>
		</variable>
		<variable>
			<variable type='bool'>heard_sound</variable>
			<value type='bool'>false</value>
		</variable>
	</blackboard>
	<!-- ******************************************************************** -->
	<node type='Loop' name='main control'>
	<onerror action='failed'/>
	<condition>until_all_fail</condition>
	<tree>
		<node type='WaitIdle' name='Wait for action'>
			<exit>
				<if>
					<variable type='bool'>player_visible</variable>
					<value type='bool'>true</value>
				</if>
				<if>
					<variable type='bool'>hit_bullet</variable>
					<value type='bool'>true</value>
				</if>
				<if>
					<variable type='bool'>heard_sound</variable>
					<value type='bool'>true</value>
				</if>
			</exit>
		</node>
		<node type='GameEngine:SetVar' name='reset heard sound'>
			<variable type='bool'>heard_sound</variable>
			<value type='bool'>false</value>
		</node>
		<node type='GameEngine:SetVar' name='reset hit_bullet'>
			<variable type='bool'>hit_bullet</variable>
			<value type='bool'>false</value>
		</node>
		<!--	-->
		<node type='GameEngine:SetVar' name='force target'>
			<variable type='vec3' value='-21.29,-0.3,16.6'>static_position</variable>
			<value type='vec3'>-21.29,-0.3,16.6</value>
		</node>
		<node type='GameEngine:SetVar' name='define satnav target'>
			<variable type='vec3' value='=static_position'>entity_position</variable>
			<value type='vec3'>=static_position</value>
		</node>
		<node type='task' task ='moveAndOpenDoor' name='stroll back to wait position'>
		</node>
		<node type='DarkForces:State' name='change back to static pose'>
			<state>ENEMY_STAY_STILL</state>
		</node>
		<!--	-->
	</tree>
	</node>
</behaviortree>