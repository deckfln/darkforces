<behaviortree>
	<messages>
		<message id='GameEngine:HEAR_SOUND'>GameEngine:onHearSound</message>
		<message id='GameEngine:VIEW'>GameEngine:onViewPlayer</message>
		<message id='GameEngine:NOT_VIEW'>GameEngine:onNotViewPlayer</message>
		<message id='GameEngine:BULLET_HIT'>GameEngine:onBulletHit</message>
		<message id='DarkForces:DYING'>DarkForces:onDying</message>
	</messages>
	<node type='Loop' name='main control'>
	<onerror action='failed'/>
	<condition>until_all_fail</condition>
	<tree>
		<node type='WaitIdle' name='Wait for action'>
			<exits>
				<exit value='true'>player_visible</exit>
				<exit value='true'>hit_bullet</exit>
				<exit value='true'>heard_sound</exit>
			</exits>
		</node>
		<!-- 
		-->
				<node type='GameEngine:SetVar' name='force target'>
					<variable type='vec3' value='-21.29,-0.3,16.6'>static_position</variable>
				</node>
				<node type='Loop' name='stroll back to wait position'>
					<condition>unless_one_succeed</condition>
					<tree>
						<node type='SatNav' name='direct go to wait position'>
							<position type='vec3'>static_position</position>
							<exits>
								<exit value='true'>player_visible</exit>
								<exit value='true'>hit_bullet</exit>
								<exit value='true'>heard_sound</exit>
							</exits>
						</node>
						<node type='DarkForces:WaitDoor' name='if door is opening, wait for end of opening'></node>
						<node type='Sequence' name='open a door to go to wait position'>
							<tree>
								<node type='DarkForces:SetVar' name='number of triggers of an elevator'>
									<variable type='var' value='elevator.triggers.count'>max_triggers</variable>
								</node>
								<node type='GameEngine:For' name='try to reach each trigger of the door'>
									<variable>trigger</variable>
									<start type='int32' value='0' />
									<end type='var' value='max_triggers' />
									<condition>all_success</condition>
									<default_return>failure</default_return>
									<tree>
										<node type='DarkForces:SetVar' name='position of current trigger'>
											<variable type='variable' value='elevator.triggers[trigger].position'>trigger_position</variable>
										</node>
										<node type='DarkForces:SetVar' name='name of current trigger'>
											<variable type='var' value='elevator.triggers[trigger].name'>trigger_name</variable>
										</node>
										<node type='SatNav' name='go to trigger'>
											<position type='vec3'>trigger_position</position>
										</node>
									</tree>
								</node>
								<node type='DarkForces:Activate' name='push the trigger'>
									<variable>trigger_name</variable>
								</node>
								<node type='DarkForces:WaitDoor' name='wait for door to open'></node>
							</tree>
						</node>
					</tree>
				</node>
		<!--
		-->
		<node type='Loop' name='attack and track'>
			<tree>
				<node type='Loop' name='find the player, move toward him and shoot at him'>
					<condition>until_one_fail</condition>
					<tree>
					<node type='GameEngine:CheckVar' name='player is visible'>
						<variable type='bool' value='true'>player_visible</variable>
					</node>
					<node type='darkForces:sound' name='tease the player'>
						<sounds>
		<include file='sounds.inc'/>
						</sounds>
					</node>
					<node type='Fire2Player' name='Shoot player'></node>
					<node type='Sequence' name='Move to player position'>
						<tree>
							<node type='DarkForces:Move2Player' name='set the player nearby position'>
								<variable type='vec3'>player_last_position</variable>
							</node>
							<node type='GameEngine:Alarm' name='walk for limited time'>
								<message>GameEngine:SatNav_CANCEL</message>
								<timer max='3000' min='1500' />
							</node>
							<node type='SatNav' name='move to player'>
								<exits>
									<exit value='true'>nearby_player</exit>
								</exits>
								<position type='vec3'>player_last_position</position>
							</node>
						</tree>
					</node>
					</tree>
				</node>
				<node type='Sequence' name='move to player last known position'>
					<condition>invert</condition>	<!-- reaching the end of trip means not seing/hearing anything, so it is actualy a failure-->
					<tree>
						<node type='DarkForces:TrackPlayer' name='set player last known position (view/soud)'>
							<variable type='vec3'>track_player_position</variable>
						</node>
						<node type='SatNav' name='move to player last position'>
							<position type='vec3'>track_player_position</position>
							<exits>
								<exit value='true'>player_visible</exit>
								<exit value='true'>hit_bullet</exit>
							</exits>
						</node>
					</tree>
					<!--
					<tree>
						<node type='Sequence' name='move to the last seen/heard position and do a 360 scan'>
							<condition>until_one_fail</condition>
							<tree>
								<node type='SatNav' name='move to player last position'>
									<exits>
										<exit value='true'>player_visible</exit>
										<exit value='true'>hit_bullet</exit>
									</exits>
								</node>
								<node type='GameEngine:Turn' name='scan around'>
									<exits>
										<exit value='true'>player_visible</exit>
										<exit value='true'>hit_bullet</exit>
									</exits>
									<delay>1</delay>
									<angles>
										<angle>-90</angle>
										<angle>90</angle>
										<angle>90</angle>
									</angles>
								</node>
							</tree>
						</node>
					</tree>
					-->
				</node>
			</tree>
		</node>
		<node type='Sequence' name='stroll back to wait position and reset flags'>
			<condition>unless one fails</condition>
			<tree>
				<node type='MoveEnemyTo' name='stroll back to wait position'>
					<condition>unless_one_succeed</condition>
					<tree>
						<node type='SatNav' name='direct go to wait position'>
							<position type='vec3'>static_position</position>
							<exits>
								<exit value='true'>player_visible</exit>
								<exit value='true'>hit_bullet</exit>
								<exit value='true'>heard_sound</exit>
							</exits>
						</node>
						<node type='DarkForces:WaitDoor' name='if door is opening, wait for end of opening'></node>
						<node type='Sequence' name='open a door to go to wait position'>
							<tree>
								<node type='DarkForces:SetVar' name='number of triggers of an elevator'>
									<variable type='var' value='elevator.triggers.count'>max_triggers</variable>
								</node>
								<node type='GameEngine:For' name='try to reach each trigger of the door'>
									<variable>trigger</variable>
									<start type='int32' value='0' />
									<end type='var' value='max_triggers' />
									<condition>all_success</condition>
									<default_return>failure</default_return>
									<tree>
										<node type='DarkForces:SetVar' name='position of current trigger'>
											<variable type='variable' value='elevator.triggers[trigger].position'>trigger_position</variable>
										</node>
										<node type='DarkForces:SetVar' name='name of current trigger'>
											<variable type='var' value='elevator.triggers[trigger].name'>trigger_name</variable>
										</node>
										<node type='SatNav' name='go to trigger'>
											<position type='vec3'>trigger_position</position>
										</node>
									</tree>
								</node>
								<node type='DarkForces:Activate' name='push the trigger'>
									<variable>trigger_name</variable>
								</node>
								<node type='DarkForces:WaitDoor' name='wait for door to open'></node>
							</tree>
						</node>
					</tree>
				</node>
				<node type='GameEngine:SetVar' name='reset flags'>
					<variable type='bool' value='false'>heard_sound</variable>
				</node>
			</tree>
		</node>			
	</tree>
	</node>
</behaviortree>